---
title: "visualizing<br>spatial data I"
date: '2021-10-08'
output:
  xaringan::moon_reader:
    css: xaringan-themer.css
    nature:
      slideNumberFormat: "%current%"
      highlightStyle: solarized-light
      highlightLines: true
      ratio: 16:9
      countIncrementalSlides: true
      beforeInit: "https://platform.twitter.com/widgets.js"
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
xaringanExtra::use_panelset()
library(countdown)
```

```{r xaringan-themer, include = FALSE, warning = FALSE, fig.showtext = FALSE}
library(xaringanthemer)
style_duo_accent(
  primary_color = "#866fa3",
  secondary_color = "#F1DE67",
  inverse_header_color = "#464a53",
  black_color = "#464a53",
  code_highlight_color = "#f1de67",
  header_font_google = google_font("Atkinson Hyperlegible"),
  text_font_google   = google_font("Atkinson Hyperlegible", "300", "300i"),
  code_font_google   = google_font("Source Code Pro"),
  code_font_size = "20px",
  title_slide_background_color = "#FFFFFF",
  title_slide_background_image = "https://github.com/vizdata-f21/slides/raw/main/vizdata-bg.jpeg",
  title_slide_background_size = "contain",
  base_font_size = "24px",
  header_h1_font_size = "1.9rem",
  header_h2_font_size = "1.75rem",
  header_h3_font_size = "1.5rem",
  extra_css = list(
    "h1" = list("margin-block-start" = "0.4rem", 
                 "margin-block-end" = "0.4rem"),
    "h2" = list("margin-block-start" = "0.4rem", 
                 "margin-block-end" = "0.4rem"),
    "h3" = list("margin-block-start" = "0.4rem", 
                 "margin-block-end" = "0.4rem"),
    ".tiny" = list("font-size" = "70%"),
    ".small" = list("font-size" = "80%"),
    ".midi" = list("font-size" = "90%"),
    ".tiny .remark-code" = list("font-size" = "70%"),
    ".small .remark-code" = list("font-size" = "80%"),
    ".midi .remark-code" = list("font-size" = "90%"),
    ".large" = list("font-size" = "200%"),
    ".huge" = list("font-size" = "400%",
                     "font-family" = "'Montserrat', sans-serif",
                     "font-weight" = "bold"),
    ".hand" = list("font-family" = "'Gochi Hand', cursive",
                   "font-size" = "125%"),
    ".task" = list("padding-right"    = "10px",
                   "padding-left"     = "10px",
                   "padding-top"      = "3px",
                   "padding-bottom"   = "3px",
                   "margin-bottom"    = "6px",
                   "margin-top"       = "6px",
                   "border-left"      = "solid 5px #F1DE67",
                   "background-color" = "#F1DE6750"),
    ".note" = list("padding-right"    = "10px",
               "padding-left"     = "10px",
               "padding-top"      = "3px",
               "padding-bottom"   = "3px",
               "margin-bottom"    = "6px",
               "margin-top"       = "6px",
               "border-left"      = "solid 5px #866fa3",
               "background-color" = "#866fa350"),
    ".pull-left" = list("width" = "49%",
                        "float" = "left"),
    ".pull-right" = list("width" = "49%",
                         "float" = "right"),
    ".pull-left-wide" = list("width" = "70%",
                             "float" = "left"),
    ".pull-right-narrow" = list("width" = "27%",
                                "float" = "right"),
    ".pull-left-narrow" = list("width" = "27%",
                               "float" = "left"),
    ".pull-right-wide" = list("width" = "70%",
                              "float" = "right"),
    ".blue" = list(color = "#2A9BB7"),
    ".purple" = list(color = "#a493ba"),
    ".yellow" = list(color = "#f1de67"),
    ".gray" = list(color = "#464a53")
    )
  )
```

class: middle, inverse

# Welcome

---

## Announcements

- Let me know by the end of class today if you want to work on improving your Project 1

- Decide as a team if you'd like to "own" your Project 1 repo and share it as part of your portfolio publicly, email me to let me know

- Get started on HW 3 before lab on Monday so you can get questions answered

---

## Setup

.midi[
```{r message = FALSE, warning = FALSE}
# load packages
library(tidyverse)
library(fs)
library(lubridate)
library(colorblindr)
library(gghighlight)
library(highcharter)

# set default theme for ggplot2
ggplot2::theme_set(ggplot2::theme_minimal(base_size = 16))

# set default figure parameters for knitr
knitr::opts_chunk$set(
  fig.width = 8, fig.asp = 0.618, fig.retina = 3,
  dpi = 300, out.width = "60%"
)

# dplyr print min and max
options(dplyr.print_max = 6, dplyr.print_min = 6)
```
]

---

class: middle, inverse

# Wrap up: Visualizing multiple trends

---

## Remember: Air Quality Index

- The AQI is the Environmental Protection Agency's index for reporting air quality

- Higher values of AQI indicate worse air quality

```{r echo = FALSE, fig.alt = "AQI Basics for Ozone and Particle Pollution", out.width = "100%"}
knitr::include_graphics("images/aqi-levels.png")
```

.footnote[
Source: https://www.airnow.gov/aqi-basics
]

---

## AQI data

- Source: [EPA's  Daily Air Quality Tracker](https://www.epa.gov/outdoor-air-quality-data/air-data-daily-air-quality-tracker)

- 2016 - 2021 AQI (Ozone and PM2.5 combined) for Durham-Chapel Hill, NC core-based statistical area (CBSA), one file per year

```{r include = FALSE}
dch_files <- fs::dir_ls(here::here("11-visualize-time-series/", "data/durham-chapel-hill"))
```

.midi[
```{r eval = FALSE}
dch_files <- fs::dir_ls(here::here("data/durham-chapel-hill"))
```
]

.midi[
```{r message = FALSE}
dch <- read_csv(dch_files, na = c(".", ""))
```
]

- 2016 - 2021 AQI (Ozone and PM2.5 combined) for San Francisco-Oakland-Hayward, CA CBSA, one file per year

```{r include = FALSE}
sf_files <- fs::dir_ls(here::here("11-visualize-time-series/", "data/san-francisco"))
```

.midi[
```{r eval = FALSE}
sf_files <- fs::dir_ls(here::here("data/san-francisco"))
```
]

.midi[
```{r message = FALSE}
sf <- read_csv(sf_files, na = c(".", ""))
```
]

---

## Data cleaning

- Durham-Chapel Hill

.midi[
```{r}
dch <- dch %>%
  janitor::clean_names() %>%
  mutate(date = mdy(date),
         aqi_value = as.numeric(aqi_value),
         good_aqi = if_else(aqi_value <= 50, 1, 0)) %>%
  filter(!is.na(aqi_value)) %>%
  arrange(date) %>%
  mutate(cum_good_aqi = cumsum(good_aqi), .after = aqi_value)
```
]

- San Francisco-Oakland-Hayward

.midi[
```{r}
sf <- sf %>%
  janitor::clean_names() %>%
  mutate(date = mdy(date),
         aqi_value = as.numeric(aqi_value),
         good_aqi = if_else(aqi_value <= 50, 1, 0)) %>%
  filter(!is.na(aqi_value)) %>%
  arrange(date) %>%
  mutate(cum_good_aqi = cumsum(good_aqi), .after = aqi_value)
```
]

---

## Visualizing annual trends

```{r}
sf <- sf %>%
  mutate(
    year = year(date), 
    month = month(date),
    day = day(date),
    fake_date = ymd(as.Date(paste0(2000, "-", month, "-", day))),
    .after = date
    )

sf
```

---

## Visualizing annual trends

.panelset.sideways[
```{r panelset = c(source = "Code", output = "Plot"), out.width = "90%"}
ggplot(sf, aes(x = fake_date, y = aqi_value, 
               group = year, color = factor(year))) +
  geom_line() +
  scale_x_date(date_labels = "%b") +
  scale_color_OkabeIto() +
  labs(
    x = NULL, y = "AQI", color = "Year",
    title = "Ozone and PM2.5 Daily AQI Values",
    subtitle = "San Francisco-Oakland-Hayward, CA",
    caption = "\nSource: EPA Daily Air Quality Tracker"
  ) +
  theme(
    plot.title.position = "plot",
    panel.grid.minor.y = element_blank(),
    panel.grid.minor.x = element_blank()
  )
```
]

---

## Highlighting

.panelset.sideways[
```{r panelset = c(source = "Code", output = "Plot"), out.width = "100%", message = FALSE, warning = FALSE}
ggplot(sf, aes(x = fake_date, y = aqi_value, group = year)) +
  geom_line() +
  gghighlight(year == 2018, label_key = year) + #<<
  scale_x_date(date_labels = "%b") +
  labs(
    x = NULL, y = "AQI", color = "Year",
    title = "Ozone and PM2.5 Daily AQI Values",
    subtitle = "San Francisco-Oakland-Hayward, CA",
    caption = "\nSource: EPA Daily Air Quality Tracker"
  ) +
  theme(
    plot.title.position = "plot",
    panel.grid.minor.y = element_blank(),
    panel.grid.minor.x = element_blank()
  )
```
]

---

class: middle

# Interactive plots

---

## Interactive plots

Using the **highcharter** package

.panelset.sideways[
```{r panelset = c(source = "Code", output = "Plot"), out.width = "100%"}
highchart(type = "stock") %>%
  hc_add_series(
    data = dch, 
    hcaes(x = date, y = aqi_value), 
    type = "line",
    color = "#4E72E3",
    showInLegend = FALSE
    ) %>%
  hc_title(
    text = "Ozone and PM2.5 Daily AQI Values",
    align = "left"
    ) %>%
  hc_subtitle(
    text = "Durham-Chapel Hill, NC",
    align = "left"
    ) %>%
  hc_rangeSelector(enabled = FALSE)
```
]
