---
title: "data wrangling"
date: '`r Sys.Date()`'
output:
  xaringan::moon_reader:
    css: xaringan-themer.css
    nature:
      slideNumberFormat: "%current%"
      highlightStyle: solarized-light
      highlightLines: true
      ratio: 16:9
      countIncrementalSlides: true
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
xaringanExtra::use_panelset()
library(countdown)
```

```{r xaringan-themer, include = FALSE, warning = FALSE}
library(xaringanthemer)
style_duo_accent(
  primary_color = "#866fa3",
  secondary_color = "#F1DE67",
  inverse_header_color = "#464a53",
  black_color = "#464a53",
  code_highlight_color = "#f1de67",
  header_font_google = google_font("Atkinson Hyperlegible"),
  text_font_google   = google_font("Atkinson Hyperlegible", "300", "300i"),
  code_font_google   = google_font("Source Code Pro"),
  code_font_size = "20px",
  title_slide_background_color = "#FFFFFF",
  title_slide_background_image = "https://github.com/vizdata-f21/slides/raw/main/vizdata-bg.jpeg",
  title_slide_background_size = "contain",
  base_font_size = "24px",
  header_h1_font_size = "2rem",
  header_h2_font_size = "1.75rem",
  header_h3_font_size = "1.5rem",
  extra_css = list(
    "h1" = list("margin-block-start" = "0.4rem", 
                 "margin-block-end" = "0.4rem"),
    "h2" = list("margin-block-start" = "0.4rem", 
                 "margin-block-end" = "0.4rem"),
    "h3" = list("margin-block-start" = "0.4rem", 
                 "margin-block-end" = "0.4rem"),
    ".tiny" = list("font-size" = "70%"),
    ".small" = list("font-size" = "80%"),
    ".midi" = list("font-size" = "90%"),
    ".tiny .remark-code" = list("font-size" = "70%"),
    ".small .remark-code" = list("font-size" = "80%"),
    ".midi .remark-code" = list("font-size" = "90%"),
    ".large" = list("font-size" = "200%"),
    ".huge" = list("font-size" = "400%",
                     "font-family" = "'Montserrat', sans-serif",
                     "font-weight" = "bold"),
    ".hand" = list("font-family" = "'Gochi Hand', cursive",
                   "font-size" = "125%"),
    ".task" = list("padding-right"    = "10px",
                   "padding-left"     = "10px",
                   "padding-top"      = "3px",
                   "padding-bottom"   = "3px",
                   "margin-bottom"    = "6px",
                   "margin-top"       = "6px",
                   "border-left"      = "solid 5px #F1DE67",
                   "background-color" = "#F1DE6750"),
    ".pull-left" = list("width" = "49%",
                        "float" = "left"),
    ".pull-right" = list("width" = "49%",
                         "float" = "right"),
    ".pull-left-wide" = list("width" = "70%",
                             "float" = "left"),
    ".pull-right-narrow" = list("width" = "27%",
                                "float" = "right"),
    ".pull-left-narrow" = list("width" = "27%",
                               "float" = "left"),
    ".pull-right-wide" = list("width" = "70%",
                              "float" = "right"),
    ".blue" = list(color = "#2A9BB7"),
    ".purple" = list(color = "#a493ba"),
    ".yellow" = list(color = "#f1de67"),
    ".gray" = list(color = "#464a53")
    )
  )
```

class: middle, inverse

# Announcements

---

## Announcements

- Lab: Start work on Project 1

- Reading quiz 2 next week

- Homework 1 grading in process

---

## Agenda for today: Data wrangling

- Transforming and reshaping a single data frame

- Bringing together multiple data frames

---

## Setup

.midi[
```{r message = FALSE}
# load packages
library(tidyverse)
library(glue)
library(lubridate)
library(scales)
library(knitr)

# set default theme for ggplot2
ggplot2::theme_set(ggplot2::theme_minimal(base_size = 16))

# set default figure parameters for knitr
knitr::opts_chunk$set(
  fig.width = 8,
  fig.asp = 0.618,
  fig.retina = 3,
  dpi = 300,
  out.width = "60%"
)

# dplyr print min and max
options(dplyr.print_max = 6, dplyr.print_min = 6)
```
]

---

class: middle, inverse

# Transforming and reshaping a single data frame

---

## Data: Hotel bookings

- Data from two hotels: one resort and one city hotel
- Observations: Each row represents a hotel booking

```{r message=FALSE}
hotels <- read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-02-11/hotels.csv")
```

---

class: middle

# .hand[We...]

.huge[.blue[have]] .hand[a single data frame]

.huge[.yellow[want]] .hand[to slice it, and dice it, and juice it, and process it, so we can plot it]

---

## **dplyr** 101

.task[
Which of the following (if any) are unfamiliar to you?
]

- `distinct()`
- `select()`, `relocate()`
- `arrange()`, `arrange(desc())`
- `slice()`, `slice_head()`, `slice_tail()`, `slice_sample()`
- `filter()`
- `mutate()`
- `summarise()`, `count()`

---

.task[
Let's recreate this visualization!
]

```{r daily-stay-cost, out.width = "95%", echo = FALSE, fig.asp = 0.5}
hotels %>%
  mutate(
    arrival_date = glue("{arrival_date_year}-{arrival_date_month}-{arrival_date_day_of_month}"),
    arrival_date = ymd(arrival_date)
    ) %>%
  group_by(hotel, arrival_date) %>%
  summarise(mean_adr = mean(adr), .groups = "drop") %>%
  ggplot(aes(x = arrival_date, y = mean_adr, group = hotel, color = hotel)) +
  geom_line() +
  scale_color_manual(values = c("cornsilk4", "deepskyblue3")) +
  scale_y_continuous(labels = label_dollar()) +
  labs(
    x = "Arrival date",
    y = "Mean average\ndaily rate (USD)",
    color = NULL,
    title = "Cost of daily hotel stay",
    subtitle = "July 2015 to August 2017",
    caption = "Source: Antonio, Almeida and Nunes (2019) | TidyTuesday"
  ) +
  theme(
    legend.position = c(0.15, 0.9),
    legend.box.background = element_rect(fill = "white",
                                         color = "white"),
    plot.subtitle = element_text(color = "cornsilk4"),
    plot.caption = element_text(color = "cornsilk4")
  )
```

---

class: middle

## .hand[livecoding]

(See next slide for code developed during live coding session)

---

.small[
```{r ref.label = "daily-stay-cost", fig.show = "hide"}

```
]

---

.task[
Come up with a plan for making the following visualization and write the pseudocode.
]

.panelset[
.panel[.panel-name[Plot]
```{r monthly-bookings, out.width = "88%", echo = FALSE, fig.asp = 0.5, dev = "ragg_png"}
hotels %>%
  mutate(
    arrival_date_month = fct_relevel(arrival_date_month, month.name),
    season = case_when(
      arrival_date_month %in% c("December", "January", "February") ~ "Winter",
      arrival_date_month %in% c("March", "April", "May")           ~ "Spring",
      arrival_date_month %in% c("June", "July", "August")          ~ "Summer",
      TRUE                                                         ~ "Fall"
    ),
    season = fct_relevel(season, "Winter", "Spring", "Summer", "Fall"),
    season_emoji = case_when(
      season == "Winter" ~ "❄️",
      season == "Spring" ~ "⛅️️",
      season == "Summer" ~ "☀️",
      season == "Fall"   ~ "☂️"
    )
  ) %>%
  count(season_emoji, hotel, arrival_date_month) %>%
  ggplot(aes(x = arrival_date_month, y = n, group = hotel, linetype = hotel)) +
  geom_line(size = 0.8, color = "cornsilk4") +
  geom_text(aes(label = season_emoji), size = 6, show.legend = FALSE) +
  scale_x_discrete(labels = month.abb) +
  labs(
    x = "Arrival month", y = "Number of bookings", linetype = NULL,
    title = "Number of monthly bookings",
    subtitle = "July 2015 to August 2017",
    caption = "Source: Antonio, Almeida and Nunes (2019) | TidyTuesday"
  ) +
  coord_cartesian(clip = "off") +
  theme(
    legend.position = c(0.12, 0.9),
    legend.box.background = element_rect(fill = "white", color = "white"),
    plot.subtitle = element_text(color = "cornsilk4"),
    plot.caption = element_text(color = "cornsilk4")
  )
```
]
.panel[.panel-name[Discuss]
<iframe src="https://app.sli.do/event/rxg9buzy" height="100%" width="100%" frameBorder="0" style="min-height: 560px;" title="Slido"></iframe>
]
]

```{r echo = FALSE}
countdown(minutes = 5, top = "10%")
```

---

class: middle

## .hand[livecoding]

(See next slide for code developed during live coding session)

---

.tiny[
```{r ref.label = "monthly-bookings", fig.show = "hide"}

```
]

---

## A few takeaways

- `forcats::fct_relevel()` in a `mutate()` is useful for custom ordering of levels of a factor variable

--
- `summarise()` after `group_by()` with multiple variables results in a message about the grouping structure of the resulting data frame -- the message can be supressed by defining `.groups` (e.g., `.groups = "drop"` or `.groups = "keep"`)

--
- `summarise()` also lets you get away with being sloppy and not naming your new column, but that's not recommended!

---

## Rowwise operations

.task[
We want to calculate the total number of guests for each booking. Why does the following not work?
]

```{r}
hotels %>%
  select(adults, children, babies) %>%
  mutate(guests = sum(c(adults, children, babies)))
```

---

## Rowwise operations

```{r}
hotels %>%
  select(adults, children, babies) %>%
  rowwise() %>% #<<
  mutate(guests = sum(c(adults, children, babies))) %>%
  filter(adults > 0, children > 0, babies > 0) # to show sum works
```

---

## Columnwise operations

Use `across()` combined with `summarise()` to calculate summary statistics for multiple columns at once:

```{r}
hotels %>%
  summarise(across(.cols = starts_with("stays"),  mean)) #<<

hotels %>%
  summarise(across(.cols = starts_with("stays"),  list(mean, sd))) #<<
```

---

## Select helpers

- `starts_with()`: Starts with a prefix
- `ends_with()`: Ends with a suffix
- `contains()`: Contains a literal string
- `num_range()`: Matches a numerical range like x01, x02, x03
- `one_of()`: Matches variable names in a character vector
- `everything()`: Matches all variables
- `last_col()`: Select last variable, possibly with an offset
- `matches()`: Matches a regular expression (a sequence of symbols/characters expressing a string/pattern to be searched for within text)

.footnote[
See help for any of these functions for more info, e.g. `?everything`.
]

---

## Columnwise operations

```{r}
hotels %>%
  group_by(hotel, is_canceled) %>%
  summarise(
    across(.cols = starts_with("stays"),  list(mean = mean, sd = sd), .names = "{.fn}_{.col}") #<<
    )
```

---

## Columnwise operations

```{r}
hotels %>%
  group_by(hotel, is_canceled) %>%
  summarise(
    across(.cols = starts_with("stays"),  list(mean = mean, sd = sd), .names = "{.fn}_{.col}"),
    .groups = "drop" #<<
    )
```

```{r echo = FALSE}
knitr::knit_exit()
```

## Setup for next example: `hotel_summary`

```{r}
hotels_summary <- hotels %>%
  group_by(hotel, is_canceled) %>%
  summarise(
    across(
      .cols = starts_with("stays"),
      list(mean = mean),
      .names = "{.fn}_{.col}"
    ),
    .groups = "drop"
  )

hotels_summary
```

---

.task[
Which variables are plotted in the following visualization? Which aesthetics are they mapped to?
]

.panelset[
.panel[.panel-name[Plot]
```{r out.width = "88%", echo = FALSE, fig.asp = 0.5, fig.width = 8, dev = "ragg_png"}
hotels_summary %>%
  mutate(is_canceled = if_else(is_canceled == 0, "Not canceled", "Canceled")) %>%
  pivot_longer(cols = starts_with("mean"),
               names_to = "day_type",
               values_to = "mean_stays",
               names_prefix = "mean_stays_in_") %>%
  mutate(
    day_type = if_else(str_detect(day_type, "weekend"), "Weekend", "Weekday")
    ) %>%
  ggplot(aes(x = str_wrap(is_canceled, 10), y = mean_stays, 
             group = hotel, color = hotel)) +
  geom_point(show.legend = FALSE) +
  geom_line(aes(linetype = hotel), size = 1) +
  facet_wrap(~day_type) +
  labs(
    x = "Booking status",
    y = "Mean number of\nnights of stay",
    color = NULL, linetype = NULL,
    title = "Mean number of stays",
    subtitle = "By hotel type and booking status",
    caption = "Source: Antonio, Almeida and Nunes (2019) | TidyTuesday"
  ) +
  scale_color_manual(values = c("cornsilk4", "deepskyblue3")) +
  scale_y_continuous(limits = c(0, 4), breaks = 0:4) +
  theme(legend.position = "bottom")
```
]
.panel[.panel-name[Discuss]
<iframe src="https://app.sli.do/event/rxg9buzy" height="100%" width="100%" frameBorder="0" style="min-height: 560px;" title="Slido"></iframe>
]
]

```{r echo = FALSE}
countdown(minutes = 5, top = "10%")
```

---

## `pivot_wider()` and `pivot_longer()`

.pull-left[
- From **tidyr**
- Incredibly useful for reshaping for plotting
- Lots of extra arguments to help with reshaping pain!
- Refer to [pivoting vignette](https://tidyr.tidyverse.org/articles/pivot.html) when needed
]
.pull-right[
```{r echo=FALSE, out.width="80%"}
include_graphics("images/semi-join.gif")
```
]

---

class: middle, inverse

# Bringing together multiple data frames

---

class: middle

# .hand[We...]

.huge[.blue[have]] .hand[multiple data frames]

.huge[.yellow[want]] .hand[to bring them together so we can plot them]

---

```{r include=FALSE}
professions <- read_csv("data/professions.csv")
dates <- read_csv("data/dates.csv")
works <- read_csv("data/works.csv")
```

## Data: Women in science 

Information on 10 women in science who changed the world

.small[
```{r echo=FALSE}
professions %>% select(name) %>% kable()
```
]


.footnote[
Source: [Discover Magazine](https://www.discovermagazine.com/the-sciences/meet-10-women-in-science-who-changed-the-world)
]

---

## Setup update

We have only 10 observations, so let's print them all going forward:

```{r}
options(
  dplyr.print_min = 10, 
  dplyr.print_max = 10
  )
```

---

## Inputs

.panelset[

.panel[.panel-name[professions]
```{r}
professions
```
]

.panel[.panel-name[dates]
```{r}
dates
```
]

.panel[.panel-name[works]
```{r}
works
```
]

]

---

## Desired output

```{r echo=FALSE, message = FALSE}
professions %>%
  left_join(dates) %>%
  left_join(works)
```

---

## Inputs, reminder

.pull-left[
```{r}
names(professions)
names(dates)
names(works)
```
]
.pull-right[
```{r}
nrow(professions)
nrow(dates)
nrow(works)
```
]

---

## Joining data frames

```{r eval=FALSE}
something_join(x, y)
```

- `left_join()`: all rows from x
- `right_join()`: all rows from y
- `full_join()`: all rows from both x and y
- `semi_join()`: all rows from x where there are matching values in y, keeping just columns from x
- `inner_join()`: all rows from x where there are matching values in y, return 
all combination of multiple matches in the case of multiple matches
- `anti_join()`: return all rows from x where there are not matching values in y, never duplicate rows of x
- ...
 
---

## Setup

For the next few slides...

.pull-left[
```{r echo=FALSE}
x <- tibble(
  id = c(1, 2, 3),
  value_x = c("x1", "x2", "x3")
  )
```
```{r}
x
```
]
.pull-right[
```{r echo=FALSE}
y <- tibble(
  id = c(1, 2, 4),
  value_y = c("y1", "y2", "y4")
  )
```
```{r}
y
```
]

---

## `left_join()`

.pull-left[
```{r echo=FALSE, out.width="80%", out.extra ='style="background-color: #FDF6E3"'}
include_graphics("images/left-join.gif")
```
]
.pull-right[
```{r}
left_join(x, y)
```
]

---

## `left_join()`

```{r}
professions %>%
  left_join(dates) #<<
```

---

## `right_join()`

.pull-left[
```{r echo=FALSE, out.width="80%", out.extra ='style="background-color: #FDF6E3"'}
include_graphics("images/right-join.gif")
```
]
.pull-right[
```{r}
right_join(x, y)
```
]

---

## `right_join()`


```{r}
professions %>%
  right_join(dates) #<<
```

---

## `full_join()`

.pull-left[
```{r echo=FALSE, out.width="80%", out.extra ='style="background-color: #FDF6E3"'}
include_graphics("images/full-join.gif")
```
]
.pull-right[
```{r}
full_join(x, y)
```
]

---

## `full_join()`

```{r}
dates %>%
  full_join(works) #<<
```

---

## `inner_join()`

.pull-left[
```{r echo=FALSE, out.width="80%", out.extra ='style="background-color: #FDF6E3"'}
include_graphics("images/inner-join.gif")
```
]
.pull-right[
```{r}
inner_join(x, y)
```
]

---

## `inner_join()`

```{r}
dates %>%
  inner_join(works) #<<
```

---

## `semi_join()`

.pull-left[
```{r echo=FALSE, out.width="80%", out.extra ='style="background-color: #FDF6E3"'}
include_graphics("images/semi-join.gif")
```
]
.pull-right[
```{r}
semi_join(x, y)
```
]

---

## `semi_join()`

```{r}
dates %>%
  semi_join(works) #<<
```

---

## `anti_join()`

.pull-left[
```{r echo=FALSE, out.width="80%", out.extra ='style="background-color: #FDF6E3"'}
include_graphics("images/anti-join.gif")
```
]
.pull-right[
```{r}
anti_join(x, y)
```
]

---

## `anti_join()`

```{r}
dates %>%
  anti_join(works) #<<
```

---

## Putting it altogether

.midi[
```{r}
scientists <- professions %>%
  left_join(dates) %>%
  left_join(works)

scientists
```
]

---

## `*_join()` functions

- From **dplyr**
- Incredibly useful for bringing datasets with common information (e.g., unique identifier) together
- Use `by` argument when the names of the column containing the common information are not the same across datasets
- Always check that the numbers of rows and columns of the result dataset makes sense
- Refer to [two-table verbs vignette](https://dplyr.tidyverse.org/articles/two-table.html) when needed

---

## Visualizing joined data

```{r echo = FALSE, out.width = "100%", fig.asp = 0.5, warning = FALSE, fig.width = 10, message = FALSE}
library(colorblindr) # clauswilke/colorblindr

scientists %>%
  mutate(
    birth_year = case_when(
      name == "Ada Lovelace" ~ 1815,
      name == "Marie Curie" ~ 1867,
      TRUE ~ birth_year
    ),
    death_year = case_when(
      name == "Ada Lovelace" ~ 1852,
      name == "Marie Curie" ~ 1934,
      name == "Flossie Wong-Staal" ~ 2020,
      TRUE ~ death_year
    ),
    status = if_else(is.na(death_year), "alive", "deceased"),
    death_year = if_else(is.na(death_year), 2021, death_year),
    known_for = if_else(name == "Rosalind Franklin", "understanding of the molecular structures of DNA ", known_for)
  ) %>%
  pivot_longer(
    cols = contains("year"),
    names_to = "year_type",
    values_to = "year"
  ) %>%
  mutate(death_year_fake = if_else(year == 2021, TRUE, FALSE)) %>%
  ggplot(aes(x = year, 
             y = fct_reorder(name, as.numeric(factor(profession))), 
             group = name, color = profession)) +
  geom_point(aes(shape = death_year_fake), show.legend = FALSE) +
  geom_line(aes(linetype = status), show.legend = FALSE) +
  scale_shape_manual(values = c("circle", NA)) +
  scale_linetype_manual(values = c("dashed", "solid")) + 
  scale_color_OkabeIto(darken = 0.4) +
  geom_text(aes(x = 2021, y = name, label = known_for), nudge_x = 10, show.legend = FALSE, hjust = 0) +
  coord_cartesian(clip = "off") +
  theme(
    plot.margin = unit(c(1,21,1,1), "lines"),
    plot.title.position = "plot",
    plot.caption.position = "plot"
    ) +
  labs(
    x = "Year",
    y = NULL,
    title = "10 women in science who changed the world",
    subtitle = "Works and lifespans (dashed line indicates still alive)",
    caption = "Source: Discover magazine"
  )
```
